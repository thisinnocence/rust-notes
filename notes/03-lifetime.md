# 03 - 生命周期

本章目标：把生命周期从“语法恐惧”变成“接口约束工具”。

## 1. 核心结论

- 生命周期不是“对象活多久”，而是“引用在类型系统里被允许使用多久”。
- 大多数生命周期由编译器推断；仅在接口边界不清晰时需要显式标注。

## 2. 典型需要显式标注的场景

| 场景 | 说明 |
| --- | --- |
| 返回引用 | 返回值引用必须与某个输入引用建立关系 |
| 结构体持引用 | 结构体字段是引用时需写生命周期参数 |
| 多输入引用 | 编译器无法判断返回引用来自哪一个输入 |

## 3. 最常见函数签名模式

```rust
fn pick_first<'a>(a: &'a str, _b: &'a str) -> &'a str {
    a
}
```

含义：

- 返回引用的有效期不超过 `'a`。
- `'a` 同时约束输入和输出，表达“输出借用自输入”。

### 3.1 逐符号拆解这段语法

```rust
fn pick_first<'a>(a: &'a str, _b: &'a str) -> &'a str
```

- `fn pick_first`：定义函数名。
- `<'a>`：声明一个生命周期参数，名字叫 `'a`。
- `a: &'a str`：参数 `a` 是“借用的字符串切片”，且这次借用至少在 `'a` 范围内有效。
- `_b: &'a str`：参数 `b` 也用同一个 `'a` 约束。`_b` 前缀表示该参数可能不在函数体中使用。
- `-> &'a str`：返回值也是借用引用，且生命周期同样受 `'a` 约束。

可把它读成一句话：

- “函数接收两个在 `'a` 期间有效的 `&str`，返回一个同样不超过 `'a` 的 `&str`。”

关键点：

- `'a` 不是具体时间值，也不是运行时对象。
- 它是编译期关系标签，用来说明“这些引用的生存期必须兼容”。
- `'a` 不是“给编辑器看的 hint”，而是编译器会参与类型检查的约束参数。
- 生命周期参数通常不进入运行期元信息，基本可视为零运行时开销。

补充：

- `'a` 里的 `a` 只是名字占位，可改为 `'x`、`'input`、`'left` 等合法标识，语义不变。

### 3.2 为什么要写成 `'a` 这种看起来很怪的语法

这是 Rust 的语法约定：生命周期参数统一用前缀 `'` 标识。

- `T`、`E` 这类名字通常代表类型参数（泛型类型）。
- `'a`、`'static` 这类名字代表生命周期参数。
- 前缀 `'` 的作用是“让编译器和读者一眼区分：这是生命周期，不是类型或变量”。

可对照这三类写法：

- `fn f<T>(x: T)`：`T` 是类型参数。
- `fn f<'a>(x: &'a str)`：`'a` 是生命周期参数。
- `let ch = 'a';`：这里 `'a'` 是字符字面量（单引号包起来的值）。

注意区分：

- 生命周期写法是 `'a`（前缀单引号 + 名字）。
- 字符写法是 `'a'`（两边都有单引号）。

所以它看起来“怪”，本质是为了把不同语义在语法层显式分开。

## 4. 结构体持引用的模式

```rust
struct View<'a> {
    s: &'a str,
}
```

含义：

- `View` 不能比 `s` 活得更久。
- 生命周期参数是类型契约，不是运行时字段。

## 5. 对照 C/C++ 心智

- C/C++ 可返回悬垂指针/引用（运行时才炸）。
- Rust 在编译期阻止“返回局部临时引用”这类错误。
- 所以生命周期报错通常在提醒：借用关系表达不完整或不成立。

## 6. 处理生命周期报错的步骤

- 先问：返回的引用究竟借用了谁？
- 再问：能否改为返回拥有值（`String`）以简化边界？
- 再考虑：是否需要重构作用域，缩短借用区间？

## 7. 何时不宜强行使用生命周期标注

- 如果可以返回拥有值，不宜强行返回引用。
- 如果结构体长期持有数据，优先考虑拥有语义而非借用语义。

## 8. 小结

- 生命周期不是负担，而是“把引用关系写进类型系统”的工具。

## 9. 生命周期省略规则

Rust 常见省略规则（高频）：

- 每个输入引用参数默认有独立生命周期参数。
- 若只有一个输入引用，输出引用默认继承它的生命周期。
- 若是方法且有 `&self`/`&mut self`，输出引用默认与 `self` 关联。

这就是为什么很多函数不写 `'a` 也能通过。

## 10. 返回借用还是返回拥有值

| 场景 | 推荐 |
| --- | --- |
| 返回值依赖输入借用且可零拷贝 | 返回借用（`&str`/`&[T]`） |
| 需要跨作用域长期持有 | 返回拥有值（`String`/`Vec<T>`） |
| 生命周期标注让接口明显复杂 | 优先改为拥有值，先保可维护性 |

## 11. 配套代码

对应示例：[`../src/bin/03_lifetime.rs`](../src/bin/03_lifetime.rs)。

- `pick_first`：显式生命周期关联输入与输出。
- `pick_first_elided`：演示省略规则与等价写法。
- `View<'a>`：结构体持引用。
- `choose_owned`：演示“返回拥有值”以简化边界。
